<!DOCTYPE html>
<head>
    <title>Myst - like point and click</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<style>
    *
    {
        box-sizing: border-box;
    }

    body
    {
        font-family: Arial, Helvetica, sans-serif;
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: black;
    }

    area
    {
        cursor: pointer;
    }

    img
    {
        user-drag: none; 
        user-select: none;
        -moz-user-select: none;
        -webkit-user-drag: none;
        -webkit-user-select: none;
        -ms-user-select: none;

        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
        -khtml-user-select: none;
        outline: none !important;

        user-select: none;
        margin: 0;
        padding: 0;
        top: 0;
        left: 0;

        position: fixed;
    }

    #loading
    {
        user-select: none;
        pointer-events: none;
        font-size: 20px;
        position: fixed;
        bottom: 0;
        left: 0;

        padding: 10px;
        margin: 20px;
        z-index: 99;

        color: white;
        background-color: black;
    }

    #textFrame
    {
        pointer-events: none;
        opacity: 0.75;
        position: fixed;
        z-index: 99;
        bottom: 0;
        width: 100%;
        text-align: center;
        font-size: 26px;
        padding: 20px;

        color: white;
        background-color: black;
    }

    #textFrame p
    {
        max-width: 800px;
        margin: 0 auto;
    }

    #fullscreen 
    {
        position: fixed;
        top: 0;
        right: 0;
        width: 50px;
        height: 50px;
        background-color: #000;
        background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACYAAAAmAQMAAACS83vtAAAABGdBTUEAALGOfPtRkwAAAAZQTFRF////AAAAVcLTfgAAAChJREFUCNdj+A8Efxgg5AHGfww8OMmD////I4VENpkYklTz8bsWyWQAquWKHztTPDkAAAAASUVORK5CYII=);
        background-size: cover;
        z-index: 999;
        opacity: 0.5;
        cursor: pointer;
        transition: 0.5s;
    }
</style>
<body>
    <div id="fullscreen"></div>
    <div id="game"></div>

    <div id="textFrame">
        <p id="text"></p>
    </div>

    <div id="loading">Loading...</div>
</body>

<script>
"use strict";

var isFullScreen = -1;
var textTime = 0;
var imagesMax = 0;
var imagesLoaded = 0;
var currentScene = "";
var sceneData = {};

document.getElementById("textFrame").style.display = "none";

setInterval(update, 1);
setup(); //starting frame

document.body.oncontextmenu = function()
{
    return false;
};

document.oncontextmenu = function()
{
    return false;
};

function createScenes(_settings)
{
    var _g = document.getElementById("game");
    currentScene = _settings["scenes"][0];
    imagesMax = _settings["scenes"].length;

    for (var i = 0; i < imagesMax; i++)
        createSingleScene(_settings["scenes"][i]);

    var _imgMap = document.createElement("map");
    _imgMap.name = "imgmap";
    _imgMap.id = "imgmap";
    _g.append(_imgMap);
}

function createSingleScene(_name)
{
    var _g = document.getElementById("game");
    fetch("scenes/" + _name + ".json", { method: 'GET'})
        .then(function(response) 
        {
            return response.json(); 
        })
        .then(function(json)
        {
            var _img = new Image();
            _img.style.display = "none";
            _img.id = _name;
            _img.draggable = false;
            _img.useMap = "#imgmap";
            _img.onload = function()
            {
                imagesLoaded++;
                var _progress = (imagesLoaded / imagesMax) * 100;
                console.log(_progress);
                document.getElementById("text").innerText = _progress;

                if (_progress >= 100)
                    scenesCompleted();
            }

            _img.src = json["image"];
            _g.append(_img);

            sceneData[_name] = {};
            sceneData[_name]["hotspots"] = json["hotspots"];
        });
}

function scenesCompleted()
{
    document.getElementById("loading").style.display = "none";
    goToScene(currentScene);
}

function goToScene(_scene)
{
    document.getElementById(_scene).style.display = "block";
    var _hotspots = sceneData[_scene]["hotspots"];
    var _getImgMap = document.getElementsByTagName("map")[0];
    _getImgMap.innerHTML = "";

    for (var i = 0; i < _hotspots.length; i++)
    {
        var _dataSplit = _hotspots[i].split('|');
        console.log(_dataSplit);

        var _area = document.createElement("area");
        _area.shape = _dataSplit[0];
        _area.coords = _dataSplit[1];
        setHotspot(_area, _dataSplit[2]);

        _getImgMap.appendChild(_area);
    }
}

function setup()
{
    fetch('settings.json', { method: 'GET'})
    .then(function(response)  { return response.json(); })
    .then(function(json) { createScenes(json); });

    // fetch('scenes/' + _scene + '.json', { method: 'GET'})
    // .then(function(response) 
    // {
    //     return response.json(); 
    // })
    // .then(function(json)
    // {
    //     var _g = document.getElementById("game");
    //     var _img = new Image();
    //     _img.draggable = false;
    //     _img.onload = function() 
    //     {
    //         document.getElementById("loading").style.display = "none";
    //         _img.useMap = "#imgmap";
    //         _g.append(_img);

    //         var _imgMap = document.createElement("map");
    //         _imgMap.name = "imgmap";

    //         for (var i = 0; i < json["hotspots"].length; i++)
    //         {
    //             var _dataSplit = json["hotspots"][i].split('|');

    //             var _area = document.createElement("area");
    //             _area.shape = _dataSplit[0];
    //             _area.coords = _dataSplit[1];
    //             setHotspot(_area, _dataSplit[2]);

    //             _imgMap.appendChild(_area);
    //         }

    //         _g.append(_imgMap);
    //         update();

    //         //dispose last image
    //         if (document.getElementsByTagName("img").length >= 2)
    //             document.getElementsByTagName("img")[0].remove();
    //     }

    //     _img.src = json["image"];
    //     _img.oncontextmenu = function()
    //     {
    //         return false;
    //     };

    //     _g.append(_img);
    //     update();
    // });
}

function setHotspot(_place, _action)
{
    var _actionSplit = _action.split('=');

    _place.onmousedown = function() 
    {
        switch (_actionSplit[0])
        {
            case "go":
            hideText();
            document.getElementById(currentScene).style.display = "none";
            currentScene = _actionSplit[1];
            goToScene(currentScene);
            break;
            case "text":
            document.getElementById("textFrame").style.display = "block";
            document.getElementById("text").innerText = _actionSplit[1];
            textTime = 800;
            break;
        }
    };
}

function hideText()
{
    document.getElementById("textFrame").style.display = "none"; 
    textTime = 0;   
}

function update()
{
    //if text is appeared
    if (textTime > 0)
    {
        textTime--;

        if (textTime < 1)
            hideText();
    }

    //Resize window
    if (document.getElementsByTagName("img").length < 1)
        return;

    var _wRef = 640;
    var _hRef = 480;
    var _aspectRef = _wRef / _hRef;

    var _w = window.innerWidth;
    var _h = window.innerHeight;
    var _aspect = _w / _h;
    
    var _marginLeft =  (_w - _wRef) / 2;
    var _marginTop = (_h - _hRef) / 2;
    
    var _wScale = _w / _wRef;
    var _hScale = _h / _hRef;
    
    for (var i = 0; i < document.getElementsByTagName("img").length; i++)
    {
        var _imgStyle =  document.getElementsByTagName("img")[i].style;
        _imgStyle.marginTop = _marginTop + "px";
        _imgStyle.marginLeft = _marginLeft + "px";
        _imgStyle.scale = (_aspect > _aspectRef) ? _hScale : _wScale;
    }

    switch (isFullScreen)
    {
        case -1:
        isFullScreen = 0;
        break;
    }

    window.scroll(0, 0);
}

document.getElementById("fullscreen").addEventListener('click', function (e) 
{
    if (isFullScreen == -1)
    return;

    try {
    var docElm = document.documentElement;
    if (docElm.requestFullscreen)
        docElm.requestFullscreen();
    else if (docElm.mozRequestFullScreen)
        docElm.mozRequestFullScreen();
    else if (docElm.webkitRequestFullScreen)
        docElm.webkitRequestFullScreen();
    else if (docElm.msRequestFullscreen)
        docElm.msRequestFullscreen();

    screen.orientation.lock("landscape");
    } catch (_e) {

    }
});

window.addEventListener("fullscreenchange", function () 
{
    isFullScreen = isFullScreen == 0 ? 1 : 0;
    document.getElementById("fullscreen").style.display = isFullScreen == 1 ? "none" : "block";
});
</script>

<!-- IIFE Reference (from Unity WebGL FIX)-->
<script>
(function() 
{
   
})();
</script>